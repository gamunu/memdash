/*jslint browser: true*/
/*global $, jQuery, alert, Chart*/
window.alert = function (text) {
    'use strict';
    console.log('tried to alert: ' + text);
    return true;
};

var $genaral = $('.general-stats'), $statics_table, $slabs_table, $sizes_table,
$items_table, $settings_table, $title = $('.stats-title'),
$refreshtime = $('#refresh-time'), timer = 0;

var requests = {
    genaral : null,
    slabs : null,
    items : null,
    settings : null,
    id : 'localhost'
};

function writeLastRefresh() {
    'use strict';
    var minutes = Math.floor(timer / 60); // 7
    var seconds = timer % 60; // 30
    
    $refreshtime.text(minutes + ':' + seconds);
}

function fetchData(id) {
    'use strict';
    requests.id = id;
    
    if (requests.genaral !== null) {
        requests.genaral.abort();
        requests.slabs.abort();
        requests.items.abort();
        requests.settings.abort();
    }
    
    $.get('stats', { server : id }, function (data) {
            $genaral.html(data).hide().fadeIn('slow');
        });
    
    $.get('graph/hits', { server : id }, function (data) {
        var ctx = document.getElementById("hits-misses").getContext("2d");
        window.ghits = new Chart(ctx).Line(data, {
            responsive: true,
            bezierCurve : false,
            pointDotRadius : 1
        });
        
        if (data.labels.length > 0) {
            $('#hits-misses').hide().fadeIn('slow');
        }
        else {
            $('#hits-misses').hide();
        }
    });
    
    $.get('graph/cmds', { server : id }, function (data) {
        var ctx = document.getElementById('graph-cmds').getContext('2d');
        window.gcmds = new Chart(ctx).Line(data, {
            responsive: true,
            bezierCurve : false,
            pointDotRadius : 1
        });
        if (data.labels.length > 0) {
            $('#graph-cmds').hide().fadeIn('slow');
            
        }
        else {
            $('#graph-cmds').hide();
        }
    });
    
    $.get('graph/cacheditems', { server : id }, function (data) {
        var ctx = document.getElementById('graph-cacheditems').getContext('2d');
        window.cacheditems = new Chart(ctx).Line(data, {
                responsive: true,
                bezierCurve : false,
                pointDotRadius : 1
            });
        if (data.labels.length > 0) {
            $('#graph-cacheditems').hide().fadeIn('slow');
        }
        else {
            $('#graph-cacheditems').hide();
        }
    });
    
    requests.genaral = $.get('statst', { server : id },
                                function (data) {
                                    if (data.length > 0) {
                                        $statics_table.fnAddData(data);
                                    }
                                });
        
    requests.slabs = $.get('slabs', { server : id },
                                function (data) {
                                    if (data.length > 0) {
                                        $slabs_table.fnAddData(data);
                                    }
                                });
        
    requests.items = $.get('items', { server : id },
                                function (data) {
                                    if (data.length > 0) {
                                        $items_table.fnAddData(data);
                                    }
                                });
        
    requests.settings = $.get('settings', { server : id },
                                function (data) {
                                    if (data.length > 0) {
                                        $settings_table.fnAddData(data);
                                    }
                                });
}

function initDataTables() {
    'use strict';
    //connect to the server before getting informaton
    //stats tab
    //Get generatl stats
    $.get('first')
    .done(function (data) {
        var id = data.id;
        $statics_table = $('#statics-table').dataTable();
        $slabs_table = $('#slabs-table').dataTable();
        $items_table = $('#items-table').dataTable();
        $settings_table = $('#settings-table').dataTable();
        $sizes_table = $('#sizes-table').dataTable();
        $title.text(data.address);
        fetchData(id);
    });
}

function clearTables() {
    'use strict';
    $statics_table.api().clear().draw();
    $slabs_table.api().clear().draw();
    //$sizes_table.api().ajax.reload();
    $items_table.api().clear().draw();
    $settings_table.api().clear().draw();
    
    window.cacheditems.destroy();
    window.gcmds.destroy();
    window.ghits.destroy();
}

function changeServer(id, server) {
    'use strict';
    $title.text(server);
    //clear tables
    clearTables();
    fetchData(id);
}

$(document).ready(function () {
    'use strict';
    
    $.get('servers', function (data) {
        var $list = $('#list');
        $list.html(data);
        initDataTables();
    });
    
    $(document).on('click', '#list li', function (e) {
        $('#list li.active').removeClass('active');
        var $this = $(this);
        if (!$this.hasClass('active')) {
            $this.addClass('active');
        }
        
        var id = $this.data('id');
        var server = $this.data('server');
        changeServer(id, server);
        e.preventDefault();
    });
    
    $(document).on('click', '#getitemstats', function (e) {
        $sizes_table.api().clear().draw();
        $.get('sizes', { server : requests.id },
                                function (data) {
                                    if (data.length > 0) {
                                        $sizes_table.fnAddData(data);
                                    }
                                });
    });
    
    $('body').tooltip({
        selector: '[rel=tooltip]'
    });
    
    setInterval(function () {
        $.get('servers', function (data) {
            var $list = $('#list');
            $list.html(data);
        });
        
        clearTables();
        changeServer(requests.id);
        timer = 0;
    }, 300000);
    
    //count up timer
    setInterval(function () {
        timer += 1;
        var minutes = Math.floor(timer / 60); // 7
        var seconds = timer % 60; // 30
        
        $refreshtime.text(minutes + 'min and ' + seconds + 's ago');
    }, 1000);
    
});